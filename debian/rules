#!/usr/bin/make -f
# -*- makefile -*-

clean:
	dh_testdir
	dh_clean
	rm -f debian/files || true

install:
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	
	# copy pyinstaller files
	cp -a opsiclientd debian/opsiclientd/usr/lib/

	# create symlink in /usr/bin
	echo "#!/bin/sh" > debian/opsiclientd/usr/bin/opsiclientd
	echo "cd /usr/lib/opsiclientd" >> debian/opsiclientd/usr/bin/opsiclientd
	echo "./opsiclientd \$$@" >> debian/opsiclientd/usr/bin/opsiclientd
	chmod 755 debian/opsiclientd/usr/bin/opsiclientd

	# copy locales
	for i in gettext/*.mo; do \
		lang=$$(basename $$i | cut -d'_' -f2 | cut -d'.' -f1) && \
		mkdir -p debian/opsiclientd/usr/share/opsiclientd/locale/$$lang/LC_MESSAGES && \
		install -m 0644 $$i debian/opsiclientd/usr/share/opsiclientd/locale/$$lang/LC_MESSAGES/opsiclient.mo \
	; done

	# copy static_html
	cp -a static_html debian/opsiclientd/usr/share/opsiclientd/
	find debian/opsiclientd/usr/share/opsiclientd -type f -exec chmod 644 "{}" \;
	find debian/opsiclientd/usr/share/opsiclientd -type d -exec chmod 755 "{}" \;

	# copy copnfig file
	install -m 0644 src/linux/opsiclientd.conf -t debian/opsiclientd/etc/opsi-client-agent

	dh_install

override_dh_auto_install:
	dh_auto_install
	dh_systemd_enable || true
	dh_systemd_start || true

binary-indep: install
	dh_testdir -i
	dh_installdebconf
	dh_installchangelogs -i
	dh_systemd_enable
	dh_systemd_start
	dh_md5sums
	dh_gencontrol
	dh_installdeb
	dh_builddeb

binary: binary-indep
build:
.PHONY: clean binary-indep binary install build
