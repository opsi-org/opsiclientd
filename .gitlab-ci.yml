image: python:3.7-stretch

stages:
  - build
  - package

build:linux-pyinstaller:
  stage: build
  script:
    - apt update
    - apt -y upgrade
    - apt -y install curl
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python3
    - source $HOME/.poetry/env
    - sed -i s'/^python-opsi = .*/python-opsi = "^4.2"/' pyproject.toml
    - poetry update python-opsi
    - poetry run opsi-dev-tool -l info --pyinstaller-poetry-build
    - mv opsiclientd opsiclientd.src
    - mv dist/opsiclientd .
  artifacts:
    name: 'opsiclientd-linux-pyinstaller'
    paths:
      - opsiclientd
    expire_in: 2 day

package:deb:
  stage: package
  dependencies:
    - build:linux-pyinstaller
  script:
    - apt update
    - apt -y upgrade
    - apt -y install debhelper
    - deps=$((dpkg-checkbuilddeps 2>&1 | sed "s/dpkg-checkbuilddeps\:\serror\:\sUnmet build dependencies\://g" | sed "s/[\(][^)]*[\)] //g") || echo -n "")
    - echo $deps
    - test -z "$deps" || apt -y install $deps
    - dpkg-buildpackage -b
    - mkdir deb
    - mv ../opsiclientd_*.deb deb/

  artifacts:
    name: 'opsiclientd-deb'
    paths:
      - deb/*
    expire_in: 2 day

build:macos-pyinstaller:
      stage: build
      tags:
        - macos
      script:
        - source $HOME/.poetry/env
        - sed -ie s'/^python-opsi = .*/python-opsi = "^4.2"/' pyproject.toml
        - poetry update python-opsi
        - poetry run opsi-dev-tool -l info --pyinstaller-poetry-build
        - mv opsiclientd opsiclientd.src
        - mv dist/opsiclientd .
      artifacts:
        name: 'opsiclientd-macos-pyinstaller'
        paths:
          - opsiclientd
        expire_in: 2 day

build:windows-pyinstaller:
  stage: build
  tags:
    - win10
  script:
    - pip install poetry
    #- Get-Content pyproject.toml | %{ $_ -Replace '"^python-opsi = .*"', 'python-opsi = "^4.2"' } | Out-File -Encoding ASCII "pyproject.tmp"
    #- Move-Item -Path "pyproject.tmp" -Destination "pyproject.toml" -Force
    #- Get-Content pyproject.toml
    - poetry update python-opsi
    - poetry run opsi-dev-tool -l debug --pyinstaller-poetry-build
    - Move-Item -Path opsiclientd -Destination opsiclientd.src -Force
    - Move-Item -Path dist\opsiclientd -Destination opsiclientd
  artifacts:
    name: 'opsiclientd-windows-pyinstaller'
    paths:
      - opsiclientd
    expire_in: 2 day
